<!doctype html>

<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]> <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]> <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Catwalk Test Page</title>

	<style type="text/css" media="screen">
		table th {
	 		text-align: left;
		}
		table th,
		table td {
			padding: 4px;
		}
		table tr:nth-child( 2n + 1 ) {
			background-color: #EEE;
		}
	</style>
	<!-- Bootstrap -->
	<script src="/scripts/libraries/underscore-min.js" type="text/javascript" charset="utf-8"></script>
	<script src="/scripts/libraries/underscore-mixins.js" type="text/javascript" charset="utf-8"></script>
	<script src="/scripts/libraries/jquery-1.7.1.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="/scripts/libraries/dust-full-0.3.0.min.js" type="text/javascript" charset="utf-8"></script>

	<!-- Catwalk -->
	<script src="scripts/catwalk-0.0.1.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>

	<div id="container">
		<h1>Catwalk Test Page</h1>
		<div id="data">
			<table>
				<thead>
				  <tr>
					<th><a class="sort" data-property="id" data-type="string" href="#">Article Id</a></th>
					<th><a class="sort" data-property="title" data-type="number" href="#">Title</a></th>
					<th><a class="sort" data-property="summary" href="#" data-type="string">Summary</a></th>
					<th>Trending</th>
					<th><a class="sort" data-property="date" href="#" data-type="date">Date</a></th>
				  </tr>
				<thead>
				<tbody id="results">
				<tbody>
			</table>
		</div>
	</div>
	<script id="results" type="text/template" data-template-id="results" charset="utf-8">
		  {#results}
		  <tr>
			<td>{id}</td>
			<td>{title}</td>
			<td>{summary}</td>
			<td>
				{?trending}
				<ul>
					{#trending}
					<li>{name}</li>
					{/trending}
				</ul>
				{/trending}
			</td>
			<td>{date}</td>
		  </tr>
		  {/results}
	</script>
	<script type="text/javascript" charset="utf-8">
		$( function() {
			var $templates = $( 'script[type="text/template"]' );

			$templates.each( function( index, item ) {
				var $this = $( item );
				dust.loadSource( dust.compile( $this.html(), $this.data( 'template-id' ) ) );
			} );

		} );
	</script>
	<script type="text/javascript" charset="utf-8">
		$( function () {
			var Articles = new Catwalk.Collection();

			function render( data ) {
				dust.render( 'results', { results: data }, function( error, output ) {
					$( '#results' ).html( output );
				} );
			}

			function normalize( data ) {
				var object = _.normalize( {
					id: '[\'articleResult\'][\'articleId\']',
					title: '[\'memberArticle\'][\'articleContent\'][\'title\']',
					summary: '[\'memberArticle\'][\'articleContent\'][\'summary\']',
					date: '[\'memberArticle\'][\'articleContent\'][\'fetchDate\']'
				}, data );
				object.date = new Date( data.date ).toUTCString();
				object.trending = [];
				_.each( item.articleResult.trendingInEntities, function( item, index ) {
					data.trending.push( _.normalize( {
						name: '[\'vanityName\']',
						id: '[\'entityId\']',
						type: '[\'entityType\']',
						vanity: '[\'vanityName\']'
					}, data ) );
				} );
			}

			$.getJSON( '/data/today.json', function( data ) {
				_.each( data.content.news_container_section.newsList, function( item, index ) {
					var data = normalize( item );
					Articles.add( new Catwalk.Model( data ) );
				} );
				render( Articles.data() );
			} );

			$( '.sort' ).on( 'click', function( event ) {
				event.preventDefault();dx

				var $this = $( this ),
					sort,
					property,
					type,
					data,
					ASCENDING = 'ascending',
					DESCENDING = 'descending';

				sort = $this.data( 'sort' );
				type = $this.data( 'type' );
				property = $this.data( 'property' );
				data = Articles.sort( function( item, index ) {
					var value = item[property];
					switch( type ) {
						case 'number':
							return parseFloat( value );
							break;
						case 'string':
							return '' + value + '';
							break;
						case 'boolean':
							if( value ) {
								return true;
							} else {
								return false;
							}
							break;
						case 'date':
							return new Date( value );
							break;
						default:
							return value;
							break;
					}
				} );

				if( !sort || sort === DESCENDING ) {
					sort = ASCENDING;
				} else if( sort === ASCENDING ) {
					sort = DESCENDING;
					data = data.reverse();
				}

				render( data );

				$this.data( 'sort', sort );
				$this.removeClass( ASCENDING + ' ' + DESCENDING ).addClass( sort );

			} );

		} );
	</script>
</body>

</html>

